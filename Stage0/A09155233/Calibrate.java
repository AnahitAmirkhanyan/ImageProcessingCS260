import ij.*;
import ij.process.*;
import ij.gui.*;
import java.awt.*;
import ij.plugin.filter.*;

public class Calibrate implements PlugInFilter {
	ImagePlus imp;

	public int setup(String arg, ImagePlus imp) {
		this.imp = imp;
		return DOES_ALL;
	}

	public void run(ImageProcessor ip) {
        //ip.invert();
        Color color;

        // benchmark histograms hardcoded
        double[] bm_red = {0.277777777777777,0.277777777777777,0.277777777777777,0.277777777777777,0.277777777777777,0.277809829059829,0.278130341880341,0.279743589743589,0.282702991452991,0.287371794871794,0.294700854700854,0.303557692307692,0.313621794871794,0.324829059829059,0.337243589743589,0.349465811965811,0.360373931623931,0.370502136752136,0.380576923076923,0.390779914529914,0.40076923076923,0.41017094017094,0.4196047008547,0.428130341880341,0.436314102564102,0.444198717948717,0.451431623931623,0.458504273504273,0.463974358974358,0.468728632478632,0.472863247863247,0.476816239316239,0.480309829059829,0.483643162393162,0.486816239316239,0.490181623931623,0.493076923076923,0.495405982905982,0.49767094017094,0.5,0.502115384615384,0.504102564102564,0.505993589743589,0.507959401709401,0.509679487179487,0.511047008547008,0.512606837606837,0.514369658119658,0.515918803418803,0.517542735042735,0.518974358974359,0.520822649572649,0.522371794871794,0.523803418803418,0.525299145299145,0.52684829059829,0.528643162393162,0.529989316239316,0.531485042735042,0.533044871794871,0.534529914529914,0.536100427350427,0.537777777777777,0.539273504273504,0.540833333333333,0.542361111111111,0.543846153846153,0.545523504273504,0.546997863247863,0.548632478632478,0.550384615384615,0.551773504273504,0.553408119658119,0.555096153846153,0.556880341880341,0.558611111111111,0.560405982905982,0.56201923076923,0.56375,0.565491452991453,0.567254273504273,0.568974358974359,0.570566239316239,0.571944444444444,0.573611111111111,0.575448717948718,0.577254273504273,0.579123931623931,0.581036324786324,0.582660256410256,0.584369658119658,0.586346153846153,0.588237179487179,0.590096153846153,0.591987179487179,0.593899572649572,0.596014957264957,0.597905982905983,0.600042735042735,0.602061965811965,0.604230769230769,0.60650641025641,0.608942307692307,0.611239316239316,0.613899572649572,0.616645299145299,0.619487179487179,0.622724358974359,0.625790598290598,0.629038461538461,0.632211538461538,0.635641025641025,0.639572649572649,0.64392094017094,0.648002136752136,0.652574786324786,0.656987179487179,0.661538461538461,0.666132478632478,0.670993589743589,0.676121794871794,0.681410256410256,0.686410256410256,0.69176282051282,0.697126068376068,0.701730769230769,0.706314102564102,0.710309829059829,0.714658119658119,0.718814102564102,0.723247863247863,0.727820512820512,0.732307692307692,0.736388888888888,0.7408547008547,0.745096153846153,0.749722222222222,0.754636752136752,0.759561965811965,0.764572649572649,0.769198717948718,0.773856837606837,0.778632478632478,0.782895299145299,0.787200854700854,0.792158119658119,0.797297008547008,0.803365384615384,0.80917735042735,0.816314102564102,0.824529914529914,0.833589743589743,0.842350427350427,0.850277777777777,0.858023504273504,0.86551282051282,0.872638888888888,0.879850427350427,0.886143162393162,0.891666666666666,0.896367521367521,0.90008547008547,0.903034188034188,0.905523504273504,0.907510683760683,0.909423076923076,0.911164529914529,0.912895299145299,0.914337606837606,0.915651709401709,0.917307692307692,0.919038461538461,0.921217948717948,0.923408119658119,0.925897435897435,0.928867521367521,0.932339743589743,0.936228632478632,0.941388888888888,0.947329059829059,0.953899572649572,0.960918803418803,0.967126068376068,0.972425213675213,0.978258547008547,0.985138888888888,0.991602564102564,0.996111111111111,0.99844017094017,0.999380341880341,0.999775641025641,0.999935897435897,0.999978632478632,0.999989316239316,0.999989316239316,0.999989316239316,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,};
        double[] bm_green = {0.277777777777777,0.277777777777777,0.277788461538461,0.277788461538461,0.277788461538461,0.277863247863247,0.27818376068376,0.279807692307692,0.282938034188034,0.287948717948717,0.295737179487179,0.305715811965812,0.318162393162393,0.332478632478632,0.347638888888888,0.363162393162393,0.378643162393162,0.392286324786324,0.406239316239316,0.419583333333333,0.431880341880341,0.443482905982905,0.454294871794871,0.464540598290598,0.473365384615384,0.481901709401709,0.489294871794871,0.495641025641025,0.501111111111111,0.506431623931623,0.51133547008547,0.515961538461538,0.520277777777777,0.523824786324786,0.527382478632478,0.530972222222222,0.534198717948718,0.537200854700854,0.540160256410256,0.543226495726495,0.545908119658119,0.548867521367521,0.551987179487179,0.554743589743589,0.557596153846153,0.560160256410256,0.562831196581196,0.565801282051282,0.568579059829059,0.571004273504273,0.573782051282051,0.576282051282051,0.578643162393162,0.581079059829059,0.583611111111111,0.58594017094017,0.588247863247863,0.590651709401709,0.593108974358974,0.595726495726495,0.598547008547008,0.601442307692307,0.604155982905982,0.606826923076923,0.609658119658119,0.612606837606837,0.615470085470085,0.618333333333333,0.621068376068376,0.624070512820512,0.627158119658119,0.629935897435897,0.632809829059829,0.635940170940171,0.639145299145299,0.642638888888888,0.646239316239316,0.649455128205128,0.652767094017094,0.656239316239316,0.660042735042735,0.664220085470085,0.668600427350427,0.673728632478632,0.679401709401709,0.685833333333333,0.692991452991453,0.700064102564102,0.707457264957264,0.714316239316239,0.721185897435897,0.727478632478632,0.734305555555555,0.740491452991453,0.745972222222222,0.751367521367521,0.756367521367521,0.760192307692307,0.76434829059829,0.768386752136752,0.772905982905982,0.777179487179487,0.781228632478632,0.786025641025641,0.790705128205128,0.79542735042735,0.800416666666666,0.805544871794871,0.810459401709401,0.815897435897435,0.821794871794871,0.828226495726495,0.8346047008547,0.841688034188034,0.848739316239316,0.856153846153846,0.862564102564102,0.868044871794871,0.872243589743589,0.875331196581196,0.877403846153846,0.878728632478632,0.879839743589743,0.880587606837606,0.881239316239316,0.881741452991453,0.882179487179487,0.882660256410256,0.88301282051282,0.883258547008547,0.883514957264957,0.883867521367521,0.884081196581196,0.884316239316239,0.8846047008547,0.884914529914529,0.885138888888888,0.885438034188034,0.885758547008547,0.886100427350427,0.886485042735042,0.88676282051282,0.886976495726495,0.887393162393162,0.887713675213675,0.888002136752136,0.888279914529914,0.888696581196581,0.889027777777777,0.889401709401709,0.889732905982906,0.890149572649572,0.890502136752136,0.890950854700854,0.891474358974359,0.892029914529914,0.892467948717948,0.892980769230769,0.893568376068376,0.894294871794871,0.895021367521367,0.896303418803418,0.898087606837606,0.899903846153846,0.901324786324786,0.902831196581196,0.904583333333333,0.905822649572649,0.907094017094017,0.908322649572649,0.909594017094017,0.910790598290598,0.912051282051282,0.913333333333333,0.914668803418803,0.916239316239316,0.917809829059829,0.919626068376068,0.921634615384615,0.923985042735042,0.926570512820512,0.929401709401709,0.932467948717948,0.93676282051282,0.942767094017094,0.950213675213675,0.9583547008547,0.965811965811965,0.973258547008547,0.981196581196581,0.988739316239316,0.994316239316239,0.997564102564102,0.99909188034188,0.999636752136752,0.999861111111111,0.999946581196581,0.999989316239316,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,};
        double[] bm_blue = {0.277777777777777,0.277788461538461,0.277820512820512,0.277948717948717,0.278493589743589,0.280363247863247,0.28469017094017,0.292307692307692,0.303429487179487,0.317553418803418,0.333450854700854,0.348814102564102,0.364668803418803,0.380619658119658,0.395747863247863,0.409626068376068,0.423119658119658,0.435331196581196,0.447222222222222,0.458290598290598,0.46792735042735,0.476837606837606,0.485811965811965,0.494316239316239,0.503034188034188,0.510779914529914,0.517980769230769,0.524903846153846,0.530918803418803,0.537414529914529,0.542767094017094,0.54775641025641,0.55267094017094,0.557072649572649,0.561527777777777,0.56559829059829,0.569957264957265,0.573621794871794,0.577435897435897,0.581570512820512,0.58559829059829,0.589284188034188,0.593333333333333,0.597681623931623,0.601527777777777,0.605555555555555,0.609679487179487,0.613589743589743,0.617510683760683,0.621891025641025,0.626378205128205,0.63133547008547,0.636068376068376,0.641388888888888,0.647029914529914,0.652115384615384,0.657190170940171,0.662467948717948,0.667339743589743,0.672777777777777,0.678600427350427,0.684679487179487,0.69133547008547,0.697297008547008,0.703504273504273,0.710363247863247,0.715950854700854,0.721399572649572,0.726602564102564,0.731549145299145,0.736292735042735,0.740566239316239,0.744967948717948,0.748931623931623,0.752948717948718,0.757168803418803,0.761816239316239,0.766570512820512,0.771036324786324,0.775726495726495,0.78051282051282,0.785213675213675,0.789786324786324,0.794188034188034,0.79883547008547,0.804465811965812,0.810662393162393,0.817606837606837,0.825224358974359,0.832222222222222,0.83926282051282,0.845320512820512,0.850438034188034,0.854957264957265,0.858878205128205,0.862307692307692,0.865416666666666,0.867852564102564,0.870010683760683,0.871720085470085,0.87301282051282,0.873899572649572,0.874829059829059,0.875405982905982,0.875811965811965,0.876356837606837,0.87667735042735,0.877040598290598,0.877286324786324,0.877649572649572,0.877863247863247,0.878108974358974,0.878408119658119,0.878643162393162,0.87883547008547,0.879059829059829,0.879316239316239,0.879594017094017,0.879861111111111,0.88008547008547,0.880352564102564,0.880662393162393,0.880929487179487,0.881228632478632,0.881399572649572,0.881634615384615,0.881858974358974,0.882211538461538,0.882350427350427,0.882510683760683,0.882820512820512,0.88301282051282,0.88326923076923,0.883568376068376,0.883771367521367,0.884049145299145,0.884294871794871,0.884551282051282,0.884850427350427,0.885042735042735,0.885320512820512,0.885608974358974,0.885833333333333,0.886228632478632,0.886463675213675,0.886794871794871,0.887126068376068,0.887478632478632,0.887863247863247,0.888108974358974,0.888461538461538,0.888846153846153,0.889273504273504,0.889711538461538,0.890331196581196,0.890844017094017,0.89125,0.891666666666666,0.892136752136752,0.892596153846153,0.893162393162393,0.893878205128205,0.894658119658119,0.895608974358974,0.89701923076923,0.898878205128205,0.90076923076923,0.902190170940171,0.903461538461538,0.905064102564102,0.906324786324786,0.907403846153846,0.908653846153846,0.90969017094017,0.910897435897435,0.912222222222222,0.913472222222222,0.9146047008547,0.915908119658119,0.917275641025641,0.918707264957265,0.920715811965812,0.922970085470085,0.925010683760683,0.927713675213675,0.93034188034188,0.933472222222222,0.937329059829059,0.941987179487179,0.947745726495726,0.954027777777777,0.961228632478632,0.968728632478632,0.977029914529914,0.985138888888888,0.991517094017094,0.995566239316239,0.997938034188034,0.999209401709401,0.999722222222222,0.999882478632478,0.999967948717948,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,};
        
        double histogram_red[] = new double[256];
        double histogram_green[] = new double[256];
        double histogram_blue[] = new double[256];
        
        int r, g, b, r_new, g_new, b_new;

        for(int i = 0; i < ip.getHeight(); i++){
            for(int j = 0; j < ip.getWidth(); j++){
                color = new Color(ip.getPixel(i,j));
                r = color.getRed();
                g = color.getGreen();
                b = color.getBlue();
                histogram_red[r]++;
                histogram_green[g]++;
                histogram_blue[b]++;

            }
        }
        double [] cumulative_red = new double[256];
        double [] cumulative_green = new double[256];
        double [] cumulative_blue = new double[256];

        for(int i = 0; i < 256; i++){
            if(i == 0){
                cumulative_red[i] = histogram_red[i];
                cumulative_green[i] = histogram_green[i];
                cumulative_blue[i] = histogram_blue[i];
            }
            else{
                cumulative_red[i] = cumulative_red[i-1] + histogram_red[i];
                cumulative_green[i] = cumulative_green[i-1] + histogram_green[i];
                cumulative_blue[i] = cumulative_blue[i-1] + histogram_blue[i];
            }
        }
        
        double[] norm_cum_red = new double[256];
        double[] norm_cum_green = new double[256];
        double[] norm_cum_blue = new double[256];
 
        for(int i = 0; i < 256; i++){
            norm_cum_red[i] = cumulative_red[i]/(ip.getHeight()*ip.getWidth());
            norm_cum_green[i] = cumulative_green[i]/(ip.getHeight()*ip.getWidth());
            norm_cum_blue[i] = cumulative_blue[i]/(ip.getHeight()*ip.getWidth());
        }

        for(int i = 0; i < ip.getHeight(); i++){
            for(int j = 0; j < ip.getWidth(); j++){
                color = new Color(ip.getPixel(i,j));
                r = color.getRed();
                g = color.getGreen();
                b = color.getBlue();
                
                r_new = 255;
                while(norm_cum_red[r] < bm_red[r_new]){
                    r_new--;
                    if(r_new == 0) break;
                }
                g_new = 255;
                while(norm_cum_green[g] < bm_green[g_new]){
                    g_new--;
                    if(g_new == 0) break;
                }
                b_new = 255;
                while(norm_cum_blue[b] < bm_blue[b_new]){
                    b_new--;
                    if(b_new == 0) break;
                }
                
                int[] colors = {r_new, g_new, b_new};

                ip.putPixel(i,j, colors);


            }
        }

	}

}